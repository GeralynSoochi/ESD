<!DOCTYPE html>
<html lang="en">
<head>
	<title>GAME YO</title>
	<meta charset="UTF-8">
	<meta name="description" content="Game Warrior Template">
	<meta name="keywords" content="warrior, game, creative, html">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Favicon -->   
	<link href="img/favicon.ico" rel="shortcut icon"/>

	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=Roboto:400,400i,500,500i,700,700i" rel="stylesheet">

	<!-- Stylesheets -->
	<link rel="stylesheet" href="css/bootstrap.min.css"/>
	<link rel="stylesheet" href="css/style.css"/>
    <link rel="stylesheet" href="css/animate.css"/>
	<link rel="stylesheet" type="text/css" href="styles/bootstrap-4.1.2/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="styles/cart.css">
	<link rel="stylesheet" type="text/css" href="styles/cart_responsive.css">


	<!--[if lt IE 9]>
	  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
	<script src="https://www.paypalobjects.com/api/checkout.js"></script>
</head>
<body>
	<!--====== Javascripts & Jquery ======-->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<!-- <script src="js/jquery-3.2.1.min.js"></script> -->
	<script src="js/bootstrap.min.js"></script>
	<script src="js/owl.carousel.min.js"></script>
	<script src="js/jquery.marquee.min.js"></script>
	<script src="js/main.js"></script>
	
	<!-- Page Preloder -->
	<div id="preloder">
		<div class="loader"></div>
	</div>

	<!-- Header section -->
	<header class="header-section">
		<div class="container">
			<!-- logo -->
			<a class="site-logo" href="index.html">
				<img src="img/gameon.png" alt="">
			</a>
			<div class="user-panel" id="user">
				<a href="#">Login</a>  /  <a href="#">Register</a>
			</div>
			<!-- responsive -->
			<div class="nav-switch">
				<i class="fa fa-bars"></i>
			</div>
			<!-- site menu -->
			<nav class="main-menu">
				<ul>
					<li><a href="home.html">Home</a></li>
					<li><a href="game.html">Games</a></li>
					<li><a href="contact.html">Contact</a></li>
					<li><a href="cart.html">Cart</a></li>
				</ul>
			</nav>
		</div>
	</header>
	<!-- Header section end -->

	<!-- Page section -->

	<div class="cart_section">
		<div class="container">
			<div class="row">
				<div class="col">
					<div class="cart_container">
						
						<!-- Cart Bar -->
						<!-- <div class="cart_bar">
							<ul class="cart_bar_list item_list d-flex flex-row align-items-center justify-content-end">
								<li class="mr-auto">Product</li>
								
								<li>Price</li>
							</ul>
						</div> -->

						<!-- Cart Items -->
						<!-- <div class="cart_items">
							<ul class="cart_items_list"> -->

								<!-- Cart Item -->
								<!-- <li class="cart_item item_list d-flex flex-lg-row flex-column align-items-lg-center align-items-start justify-content-lg-end justify-content-start">
									<div class="product d-flex flex-lg-row flex-column align-items-lg-center align-items-start justify-content-start mr-auto">
										<div><div class="product_number">1</div></div>
										<div><div class="product_image"><img src="images/cart_item_1.jpg" alt=""></div></div>
										<div class="product_name_container">
											<div class="product_name"><a href="product.html">Cool Flufy Clothing without Stripes</a></div>
											<div class="product_text">Second line for additional info</div>
										</div>
									</div> -->
									
<!-- 								
									<div class="product_total product_text"><span>Total: </span>$3.99</div>
								</li>
							</ul>
						</div> -->
	<div id="main-container" class="container">
		<h1 class="display-4">Cart</h1>
		<table id="cartTable" class='table table-striped' border='0'>
			<thead class='clear'>
				<tr>
					<th>Image</th>
					<th>Name</th>
					<th>Description</th>
					<th>Price</th>
					<th></th>
				</tr>
			</thead>
		</table>
	</div>

	
						
						<!--TEST TABLE-->
						<!-- <script>
						console.log('hi');
						$.ajax({
							method: "GET",
							url: "http://127.0.0.1:5000/cart",
							context: "application/json",
							success: function (data){
								var rows = "";
								var games = data.games; 
										for (var game of games) {
											eachRow =
												"<div class = 'col-md-6'>" +
												"<div class = 'review-item'>" + 
												"<div id ='sGame'>" +
												"<img src=" + game.imageLink + " alt=game>" +
												"<h4>" + game.name + "</h4>" +
												"<p>" + game.description + "</p>" +
												"<p>$" + game.price + "</p>" +
												"<button class='site-btn btn-sm'>Add to cart</button>" + 
												"</div><div></div>";
						
											rows += eachRow + "</div></div>";
										}
										// add all the rows to the table
										$('.row').append(rows);
							}
						});
						</script> -->

						<!-- Cart Buttons -->
						<div class="cart_buttons d-flex flex-row align-items-start justify-content-start">
							<div class="cart_buttons_inner ml-sm-auto d-flex flex-row align-items-start justify-content-start flex-wrap">
								<div class="button button_clear trans_200" id = "clearall"><a href="#">clear cart</a></div>
								<div class="button button_continue trans_200"><a href="game.html">continue shopping</a></div>
							</div>
						</div>
					</div>
				</div>
			</div>
		

					<div class="cart_extra cart_extra_2">
						<div class="cart_extra_content cart_extra_total">
							<div class="cart_extra_title">Cart Total</div>
							<ul class="cart_extra_total_list">
								<!-- <li class="d-flex flex-row align-items-center justify-content-start">
									<div class="cart_extra_total_title">Subtotal</div>
									<div class="cart_extra_total_value ml-auto" ></div>
								</li> -->
								<li class="d-flex flex-row align-items-center justify-content-start">
									<div class="cart_extra_total_title">Shipping</div>
									<div class="cart_extra_total_value ml-auto">Free</div>
								</li>
								<li class="d-flex flex-row align-items-center justify-content-start">
									<div class="cart_extra_total_title">Total</div>
									<div class="cart_extra_total_value ml-auto" id ="total_price"></div>
								</li>
							</ul>
							<!-- <div class="checkout_button trans_200"><a href= "http://127.0.0.1:5008">proceed to checkout</a></div> -->
							<p><div id="paypal-button"></div></p>

							<script src="https://www.paypalobjects.com/api/checkout.js"></script>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- Footer section -->
	<footer class="footer-section">
		<div class="container">
			<ul class="footer-menu">
				<li><a href="index.html">Home</a></li>
				<li><a href="review.html">Games</a></li>
				<li><a href="contact.html">Contact</a></li>
				<li><a href="cart.html">Cart</a></li>
			</ul>
		</div>
	</footer>
</body>
	<script>
		// check if user is logged in 
		if (sessionStorage['username']){
			// console.log("logged in");
			$('#user').html("<a href='home.html' id='logout'>Logout</a>");
		
		}else{
			// console.log("not logged in");
			window.location.href = "index.html";
			// $('#user').html("<a href='index.html'>Login</a>  /  <a href='signup.html'>Register</a>");
		}
		//when user log out
		$("#logout").click(async (event) => {
			sessionStorage.clear();
		});
	</script>
	<script>
		// sessionStorage.setItem("user", 'zzz');
		// Helper function to display error message
		function showError(message) {
			// Hide the table and button in the event of error
			$('#cartTable').hide();
			// Display an error under the main container
			$('#main-container')
				.append("<label>"+message+"</label>");
		}
	
		// anonymous async function 
		// - using await requires the function that calls it to be async
		//console.log('hi');
		$(async() => {      
			//console.log('async');  
			// Change serviceURL to your own
			sub_total = 0.0
			var serviceURL = "http://127.0.0.1:5005/cart/" + sessionStorage.getItem("username");
			try {
				const response =
				 await fetch(
				   serviceURL, { method: 'GET' }
				);
				const data = await response.json();
				var cart = data.cart; //the arr is in the JSON data
				// array or array.length are falsy
				if (!cart || !cart.length) {
					showError('Cart is empty')
				} else {
					// for loop to setup all table rows with obtained games data
					var rows = "";
					var sub_total = 0;
					for (const item of cart) {
						var name = item.name + "_button";
						//console.log(name);
						eachRow =
							"<td><img src=" + item.imageLink + " alt=game></td>" +
							"<td>" + item.name + "</td>" +
							"<td>" + item.description + "</td>" +
							"<td>" + item.price + "</td>" +
							//"<td>" + "<button class='site-btn btn-sm' id=" + name + ">Delete</button>" + "</td>";
							"<td>" + "<button class='site-btn btn-sm' data-id='" + item.name + "'>Delete</button>" + "</td>";
							sub_total += item.price;
							//console.log(sub_total);
							//button to delete
							console.log(name);
							// $(document).on('click', 'button[data-id]', function (e){
							// 	var requested_to = $(this).attr('data-id');
							// 	console.log('hello');
							// 	e.preventDefault();
							// 	var serviceURL = 'http://127.0.0.1:5005/cart/delete';
							// 	var request_body = {
							// 		//needa take from session
							// 		//username: sessionStorage.getItem("username"),
							// 		username: 'abc',
							// 		name: item.name,
							// 		description: item.description,
							// 		price: item.price,
							// 		imageLink: item.imageLink
							// 	};
							// 	var request_param = {
							// 		mode: 'cors',
							// 		method: 'DELETE',
							// 		headers:{
                        	// 			'Content-Type': 'application/json;charset=utf8'
                    		// 		},
                    		// 		body: JSON.stringify(request_body)
							// 	}
							// 	fetch(serviceURL, request_param).then(response =>  {
							// 		return response.json()
							// 	});
							// });
						rows += "<tbody><tr>" + eachRow + "</tr></tbody>";
					}
					// add all the rows to the table
					$('#cartTable').append(rows);
				}
				document.getElementById("total_price").innerHTML = sub_total;
			} catch (error) {
				// Errors when calling the service; such as network error, 
				// service offline, etc
				showError
			  	('There is a problem retrieving cart data, please try again later.<br />'+error);
			   
			} // error
		});
	</script>
	<!-- button testing -->
	<script>
		// sessionStorage.setItem("user", 'zzz');
		username = sessionStorage.getItem("username")
		//button to delete
		$(document).on('click', 'button[data-id]', function (e){
			var requested_to = $(this).attr('data-id');
			console.log(requested_to);
			e.preventDefault();
			var getURL = 'http://127.0.0.1:5005/cart/' + username;
			fetch(getURL, {method: 'GET'}).then(response =>  {
				return response.json();
			}).then(data => {
				console.log(data);
				var serviceURL = 'http://127.0.0.1:5005/cart/' + username + '/' + requested_to;
				fetch(serviceURL, {method: 'DELETE'}).then(response =>  {
					return response.json();
				}).then(data => {
					console.log(data);
					location.reload();
				});
			});
		});
	</script>
	<!-- <script>
		var CREATE_PAYMENT_URL  = 'http://127.0.0.1:5006/payment';
		var EXECUTE_PAYMENT_URL = 'http://127.0.0.1:5006/execute';
	
		paypal.Button.render({
	
			env: 'sandbox', // Or 'sandbox'
	
			commit: true, // Show a 'Pay Now' button
	
			payment: function() {
				return paypal.request.post(CREATE_PAYMENT_URL).then(function(data) {
					return data.paymentID;
				});
			},
	
			onAuthorize: function(data) {
				return paypal.request.post(EXECUTE_PAYMENT_URL, {
					paymentID: data.paymentID,
					payerID:   data.payerID
				}).then(function(res) {
	
					console.log(res.success)
					// The payment is complete!
					// You can now show a confirmation message to the customer
				});
			}
	
		}, '#paypal-button');
	</script> -->
	<script>
		$('#pay').click(async (event) => {
			window.location.href('http://127.0.0.1/5008');
		});
		$('#clearall').click(async (event) =>{
			var serviceURL = "http://127.0.0.1:5005/cart/delete/"+username;
			try {
				const response =
				await fetch(
				serviceURL, { method: 'DELETE' }
				);
				const data = await response.json();
				// console.log(data.message);
				if (data.message == 'success'){
					location.reload();
				}

				
			} catch (error) {
				// Errors when calling the service; such as network error, 
				// service offline, etc
				showError
				('There is a problem clearing, please try again later.<br />'+error);
			}
		});
		var total = 0
    $(window).on('load', function() {
        final_total = document.getElementById("total_price").innerHTML;
        // console.log (total);
        // total_json = {'total': total};
        // console.log(total_json);

    // });

    // console.log (total);
    var CREATE_PAYMENT_URL  = 'http://127.0.0.1:5005/payment';
    var EXECUTE_PAYMENT_URL = 'http://127.0.0.1:5005/execute';

    paypal.Button.render({

        env: 'sandbox', // Or 'sandbox'

        commit: true, // Show a 'Pay Now' button

        payment: function() {
            return paypal.request({ method :'post', url: CREATE_PAYMENT_URL, json: {total: final_total}}).then(function(data) {
                return data.paymentID;
            });
        },

        // payment: function() {
        //     return paypal.request.post(CREATE_PAYMENT_URL, json = JSON.stringify(total)).then(function(data) {
        //         return data.paymentID;
        //     });
        // },


        onAuthorize: function(data) {
            return paypal.request.post(EXECUTE_PAYMENT_URL, {
                paymentID: data.paymentID,
                payerID:   data.payerID,
            }).then(function(res) {

        // onAuthorize: function(data) {
        //     return paypal.request({ method :'post', url: EXECUTE_PAYMENT_URL, json: {user: username}} , {
        //         paymentID: data.paymentID,
        //         payerID:   data.payerID
        //     }).then(function(res) {

                console.log(res.success)
                // The payment is complete!
                // You can now show a confirmation message to the customer
            }).then(function() {
                console.log(username)
                var serviceURL = 'http://127.0.0.1:5005/cart/delete/'+username;
                fetch(serviceURL, {method: 'DELETE'})
                .then(response =>  {
					return response.json();
				})
                .then(function(){
                    // location.reload();
                    // window.location.replace('http://127.0.0.1/esd/cart.html');
					location.reload()
                })
            });
        }

    }, '#paypal-button');
});

	</script>
	
	<!-- Page section end -->

	





	<!-- load for map -->
	<!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCWTIlluowDL-X4HbYQt3aDw_oi2JP0Krc&sensor=false"></script>
	<script src="js/map.js"></script> -->

    
</html>